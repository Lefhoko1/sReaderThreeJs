// Prisma Schema for sReader
// Tables will be auto-created from this file!

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id          String   @id @default(uuid()) @db.Uuid
  email       String?  @unique
  phone       String?
  displayName String   @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  roles       String[] @default(["STUDENT"]) // 'STUDENT', 'GUARDIAN', 'TUTOR', 'ACADEMY_ADMIN', 'SYS_ADMIN'
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profile        Profile?
  location       Location?
  devices        Device[]
  classMemberships ClassMember[]
  schedules      Schedule[]
  attempts       Attempt[]
  friendshipsFrom Friendship[] @relation("FriendshipFrom")
  friendshipsTo   Friendship[] @relation("FriendshipTo")
  notifications  Notification[]
  stats          UserStats?
  achievements   UserAchievement[]
  ownedAssets    ContentAsset[]
  
  // Role-specific relations
  student     Student?
  guardian    Guardian?
  tutor       Tutor?
  
  // Tutoring system relations
  ownedAcademies  TutoringAcademy[]      @relation("academyOwner")
  academyMemberships AcademyMembership[] @relation("academyMembership")
  instructorClasses TutoringClass[]      @relation("classInstructor")
  studentRegistrations StudentRegistrationRequest[] @relation("studentRequests")
  registrationResponses StudentRegistrationRequest[] @relation("registrationResponder")
  studentEnrollments StudentClassEnrollment[] @relation("studentEnrollments")

  @@map("users")
}

model Profile {
  userId            String  @id @map("user_id") @db.Uuid
  bio               String?
  locationConsent   Boolean @default(false) @map("location_consent")
  notificationPrefs Json    @default("{}") @map("notification_prefs")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Location {
  userId    String   @id @map("user_id") @db.Uuid
  lat       Decimal  @db.Decimal(10, 8)
  lng       Decimal  @db.Decimal(11, 8)
  address   String?
  updatedAt DateTime @default(now()) @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("locations")
}

model Device {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  pushToken String?  @map("push_token")
  platform  String // 'ios' | 'android' | 'web'
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("devices")
}

// ============================================
// ROLE-SPECIFIC USER DATA
// ============================================

model Student {
  id            String    @id @map("id") @db.Uuid
  gradeLevel    String?   @map("grade_level")
  schoolName    String?   @map("school_name")
  dateOfBirth   DateTime? @map("date_of_birth") @db.Date
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user               User                 @relation(fields: [id], references: [id], onDelete: Cascade)
  guardianRelations  GuardianStudent[]

  @@map("students")
}

model Guardian {
  id                String    @id @map("id") @db.Uuid
  relationshipToStudent String? @map("relationship_to_student") // 'PARENT', 'GRANDPARENT', 'AUNT_UNCLE', 'SIBLING', 'OTHER'
  occupation        String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user             User                @relation(fields: [id], references: [id], onDelete: Cascade)
  studentRelations GuardianStudent[]

  @@map("guardians")
}

model GuardianStudent {
  guardianId String   @map("guardian_id") @db.Uuid
  studentId  String   @map("student_id") @db.Uuid
  relationship String
  createdAt  DateTime @default(now()) @map("created_at")

  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([guardianId, studentId])
  @@map("guardian_students")
}

model Tutor {
  id                String    @id @map("id") @db.Uuid
  bio               String?
  specializations   String[]  @default([])
  educationLevel    String?   @map("education_level") // 'HIGH_SCHOOL', 'BACHELOR', 'MASTER', 'PHD'
  yearsOfExperience Int?      @map("years_of_experience")
  hourlyRate        Decimal?  @map("hourly_rate") @db.Decimal(8, 2)
  isVerified        Boolean   @default(false) @map("is_verified")
  verificationDate  DateTime? @map("verification_date")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user       User              @relation(fields: [id], references: [id], onDelete: Cascade)
  academies  TutorAcademy[]

  @@map("tutors")
}

model TutorAcademy {
  tutorId    String   @map("tutor_id") @db.Uuid
  academyId  String   @map("academy_id") @db.Uuid
  role       String   @default("INSTRUCTOR") // 'ADMIN', 'INSTRUCTOR', 'ASSISTANT'
  joinedAt   DateTime @default(now()) @map("joined_at")

  tutor      Tutor        @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  academy    Organization @relation(fields: [academyId], references: [id], onDelete: Cascade)

  @@id([tutorId, academyId])
  @@map("tutor_academies")
}

// ============================================
// TUTORING BUSINESS SYSTEM
// ============================================

model TutoringAcademy {
  id            String   @id @default(uuid()) @db.Uuid
  ownerId       String   @map("owner_id") @db.Uuid
  name          String
  description   String?
  logo          String?  @map("logo_url")
  location      String?
  phone         String?
  email         String?
  websiteUrl    String?  @map("website_url")
  isVerified    Boolean  @default(false) @map("is_verified")
  verifiedAt    DateTime? @map("verified_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  owner          User               @relation("academyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  levels         TutoringLevel[]
  subjects       TutoringSubject[]
  classes        TutoringClass[]
  memberships    AcademyMembership[]
  registrations  StudentRegistrationRequest[]
  enrollments    StudentClassEnrollment[]

  @@map("tutoring_academies")
}

model TutoringLevel {
  id          String   @id @default(uuid()) @db.Uuid
  academyId   String   @map("academy_id") @db.Uuid
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  academy   TutoringAcademy @relation(fields: [academyId], references: [id], onDelete: Cascade)
  subjects  TutoringSubject[]
  classes   TutoringClass[]

  @@unique([academyId, code])
  @@map("tutoring_levels")
}

model TutoringSubject {
  id              String   @id @default(uuid()) @db.Uuid
  academyId       String   @map("academy_id") @db.Uuid
  levelId         String   @map("level_id") @db.Uuid
  name            String
  code            String
  description     String?
  creditHours     Int?     @map("credit_hours")
  costPerMonth    Decimal? @map("cost_per_month") @db.Decimal(10, 2)
  costPerTerm     Decimal? @map("cost_per_term") @db.Decimal(10, 2)
  costPerYear     Decimal? @map("cost_per_year") @db.Decimal(10, 2)
  capacity        Int?
  syllabusUrl     String?  @map("syllabus_url")
  prerequisites   String?
  learningOutcomes String? @map("learning_outcomes")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  academy TutoringAcademy @relation(fields: [academyId], references: [id], onDelete: Cascade)
  level   TutoringLevel   @relation(fields: [levelId], references: [id], onDelete: Cascade)
  classes TutoringClass[]

  @@unique([academyId, levelId, code])
  @@map("tutoring_subjects")
}

model TutoringClass {
  id              String   @id @default(uuid()) @db.Uuid
  academyId       String   @map("academy_id") @db.Uuid
  levelId         String   @map("level_id") @db.Uuid
  subjectId       String   @map("subject_id") @db.Uuid
  instructorId    String   @map("instructor_id") @db.Uuid
  name            String
  code            String
  description     String?
  capacity        Int?
  schedule        Json     @default("{}") @map("schedule") // {days: ['MON', 'WED'], startTime: "10:00", endTime: "11:30", timezone: "UTC"}
  location        String?
  platform        String?  // 'IN_PERSON' | 'ONLINE' | 'HYBRID'
  costPerMonth    Decimal? @map("cost_per_month") @db.Decimal(10, 2)
  costPerTerm     Decimal? @map("cost_per_term") @db.Decimal(10, 2)
  costPerYear     Decimal? @map("cost_per_year") @db.Decimal(10, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  academy      TutoringAcademy            @relation(fields: [academyId], references: [id], onDelete: Cascade)
  level        TutoringLevel              @relation(fields: [levelId], references: [id], onDelete: Cascade)
  subject      TutoringSubject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  instructor   User                       @relation("classInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  registrations StudentRegistrationRequest[]
  enrollments   StudentClassEnrollment[]

  @@unique([academyId, code])
  @@map("tutoring_classes")
}

model AcademyMembership {
  id        String   @id @default(uuid()) @db.Uuid
  academyId String   @map("academy_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("INSTRUCTOR") // 'OWNER', 'ADMIN', 'INSTRUCTOR', 'ASSISTANT'
  joinedAt  DateTime @default(now()) @map("joined_at")

  academy TutoringAcademy @relation(fields: [academyId], references: [id], onDelete: Cascade)
  user    User             @relation("academyMembership", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([academyId, userId])
  @@map("academy_memberships")
}

model StudentRegistrationRequest {
  id                String   @id @default(uuid()) @db.Uuid
  studentId         String   @map("student_id") @db.Uuid
  academyId         String   @map("academy_id") @db.Uuid
  levelId           String   @map("level_id") @db.Uuid
  subjectId         String?  @map("subject_id") @db.Uuid
  classId           String   @map("class_id") @db.Uuid
  status            String   @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED', 'WITHDRAWN'
  requestedAt       DateTime @default(now()) @map("requested_at")
  respondedAt       DateTime? @map("responded_at")
  respondedBy       String?  @map("responded_by") @db.Uuid
  rejectionReason   String?  @map("rejection_reason")
  paymentStatus     String   @default("NOT_PAID") // 'NOT_PAID', 'PENDING', 'PAID'
  enrollmentStartDate DateTime? @map("enrollment_start_date")
  enrollmentEndDate DateTime? @map("enrollment_end_date")
  costTerm          String?  @map("cost_term") // 'MONTHLY', 'TERMLY', 'YEARLY'
  costAmount        Decimal? @map("cost_amount") @db.Decimal(10, 2)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  student          User                 @relation("studentRequests", fields: [studentId], references: [id], onDelete: Cascade)
  academy          TutoringAcademy      @relation(fields: [academyId], references: [id], onDelete: Cascade)
  level            TutoringLevel        @relation(fields: [levelId], references: [id], onDelete: Cascade)
  subject          TutoringSubject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  class            TutoringClass        @relation(fields: [classId], references: [id], onDelete: Cascade)
  respondent       User?                @relation("registrationResponder", fields: [respondedBy], references: [id], onDelete: SetNull)

  @@map("student_registration_requests")
}

model StudentClassEnrollment {
  id                  String   @id @default(uuid()) @db.Uuid
  studentId           String   @map("student_id") @db.Uuid
  academyId           String   @map("academy_id") @db.Uuid
  classId             String   @map("class_id") @db.Uuid
  enrolledAt          DateTime @default(now()) @map("enrolled_at")
  enrollmentEndDate   DateTime? @map("enrollment_end_date")
  paymentStatus       String   @default("PENDING") // 'PENDING', 'PAID', 'OVERDUE'
  costPaid            Decimal  @map("cost_paid") @db.Decimal(10, 2)
  costTerm            String   @map("cost_term") // 'MONTHLY', 'TERMLY', 'YEARLY'
  isActive            Boolean  @default(true) @map("is_active")
  lastPaymentDate     DateTime? @map("last_payment_date")
  nextPaymentDueDate  DateTime? @map("next_payment_due_date")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  student  User             @relation("studentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  academy  TutoringAcademy  @relation(fields: [academyId], references: [id], onDelete: Cascade)
  class    TutoringClass    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@map("student_class_enrollments")
}

// ============================================
// ORGANIZATIONS & CLASSES
// ============================================

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  type      String // 'SCHOOL' | 'TUTORING' | 'HOMESCHOOL'
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  classes      Class[]
  tutorAcademies TutorAcademy[]

  @@map("organizations")
}

model Class {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  name       String
  gradeLevel String?  @map("grade_level")
  createdAt  DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      ClassMember[]
  assignments  Assignment[]

  @@map("classes")
}

model ClassMember {
  classId  String   @map("class_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  role     String // 'TEACHER' | 'LEARNER' | 'GUARDIAN'
  joinedAt DateTime @default(now()) @map("joined_at")

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([classId, userId])
  @@map("class_members")
}

// ============================================
// ASSIGNMENTS & CONTENT
// ============================================

model Assignment {
  id            String   @id @default(uuid()) @db.Uuid
  classId       String   @map("class_id") @db.Uuid
  title         String
  description   String?
  contentBlocks Json     @default("[]") @map("content_blocks")
  dueAt         DateTime? @map("due_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  class     Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  tools     AssignmentTool[]
  schedules Schedule[]
  attempts  Attempt[]

  @@map("assignments")
}

model AssignmentTool {
  id           String @id @default(uuid()) @db.Uuid
  assignmentId String @map("assignment_id") @db.Uuid
  type         String
  uri          String?
  metadata     Json   @default("{}")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@map("assignment_tools")
}

model ContentAsset {
  id          String   @id @default(uuid()) @db.Uuid
  type        String // 'ILLUSTRATION' | 'AUDIO' | 'PDF'
  uri         String
  checksum    String?
  ownerUserId String?  @map("owner_user_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  owner User? @relation(fields: [ownerUserId], references: [id])

  @@map("content_assets")
}

// ============================================
// SCHEDULING & ATTEMPTS
// ============================================

model Schedule {
  id           String    @id @default(uuid()) @db.Uuid
  assignmentId String    @map("assignment_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  scheduledAt  DateTime  @default(now()) @map("scheduled_at")
  dueAt        DateTime? @map("due_at")
  status       String    @default("PENDING") // 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'OVERDUE'

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assignmentId])
  @@map("schedules")
}

model Attempt {
  id           String    @id @default(uuid()) @db.Uuid
  assignmentId String    @map("assignment_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  startedAt    DateTime  @default(now()) @map("started_at")
  submittedAt  DateTime? @map("submitted_at")
  score        Decimal?  @db.Decimal(5, 2)
  answers      Json      @default("[]")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("attempts")
}

// ============================================
// SOCIAL & GAMIFICATION
// ============================================

model Friendship {
  id         String   @id @default(uuid()) @db.Uuid
  fromUserId String   @map("from_user_id") @db.Uuid
  toUserId   String   @map("to_user_id") @db.Uuid
  status     String   @default("PENDING") // 'PENDING' | 'ACCEPTED' | 'REJECTED' | 'BLOCKED'
  createdAt  DateTime @default(now()) @map("created_at")

  fromUser User @relation("FriendshipFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("FriendshipTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("friendships")
}

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String
  payload   Json      @default("{}")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model UserStats {
  userId                    String    @id @map("user_id") @db.Uuid
  totalScore                Int       @default(0) @map("total_score")
  streakDays                Int       @default(0) @map("streak_days")
  lastActiveDate            DateTime? @map("last_active_date") @db.Date
  totalAssignmentsCompleted Int       @default(0) @map("total_assignments_completed")
  totalTimeSpentMinutes     Int       @default(0) @map("total_time_spent_minutes")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

model Achievement {
  id          String @id @default(uuid()) @db.Uuid
  code        String @unique
  name        String
  description String?
  icon        String?
  criteria    Json   @default("{}")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  userId        String   @map("user_id") @db.Uuid
  achievementId String   @map("achievement_id") @db.Uuid
  earnedAt      DateTime @default(now()) @map("earned_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@id([userId, achievementId])
  @@map("user_achievements")
}

